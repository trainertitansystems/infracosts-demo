name: Terraform PR FinOps Gate

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*.tf'

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  finops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update -qq && sudo apt-get install -y -qq jq bc

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/464753796348/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-terraform@siem-486017.iam.gserviceaccount.com'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: '${{ secrets.INFRACOST_API_KEY }}'

      - name: Detect changed module
        id: detect
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          FILE=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '\.tf$' | head -n 1)

          if [ -z "$FILE" ]; then
            echo "No Terraform changes detected"
            exit 0
          fi

          DIR=$(dirname "$FILE")

          if [ "$DIR" = "." ]; then
            echo "MODULE=." >> $GITHUB_ENV
          else
            echo "MODULE=$DIR" >> $GITHUB_ENV
          fi

      - name: Run Terraform + Infracost
        run: |
          cd "$MODULE"

          terraform init -input=false
          terraform plan -out=plan.tfplan -input=false
          terraform show -json plan.tfplan > plan.json

          infracost breakdown \
            --path plan.json \
            --format json \
            --out-file infracost.json

          TOTAL=$(jq '[.projects[].breakdown.totalMonthlyCost | tonumber] | add // 0' infracost.json)

          echo "TOTAL=$TOTAL" >> $GITHUB_ENV

          RESOURCE_TYPES=$(jq -r '.resource_changes[].type' plan.json | sort -u | tr '\n' ', ')
          echo "RESOURCES=$RESOURCE_TYPES" >> $GITHUB_ENV

      - name: Generate Recommendation
        run: |
          COST=$(printf "%.2f" "$TOTAL")

          if (( $(echo "$COST > 0" | bc -l) )); then
            RECOMMENDATION="Fixed monthly cost detected. Consider right-sizing instances or using committed/spot options to reduce cost."
          else
            if echo "$RESOURCES" | grep -qi "compute"; then
              RECOMMENDATION="Usage-based exposure: compute networking, egress, logging, scaling."
            elif echo "$RESOURCES" | grep -qi "pubsub"; then
              RECOMMENDATION="Usage-based exposure: message volume, data egress, subscription delivery traffic."
            elif echo "$RESOURCES" | grep -qi "network"; then
              RECOMMENDATION="Usage-based exposure: ingress, egress, NAT processing, load balancer traffic."
            else
              RECOMMENDATION="Usage-based costs may apply depending on traffic, storage, and API usage."
            fi
          fi

          echo "RECOMMENDATION=$RECOMMENDATION" >> $GITHUB_ENV

      - name: Comment on PR
        env:
          GH_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        run: |
          {
            echo "## ðŸ’° FinOps Audit: $MODULE"
            echo ""
            echo "| Field | Value |"
            echo "|:------|:------|"
            echo "| Direct Monthly Cost | \$${TOTAL} USD |"
            echo ""
            echo "## ðŸ¤– AI Recommendation"
            echo ""
            echo "- $RECOMMENDATION"
            echo ""
            echo "---"
            echo "_Generated via Infracost_"
          } > comment.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
