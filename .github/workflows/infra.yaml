name: Terraform PR FinOps Gate

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*.tf'

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  finops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update -qq && sudo apt-get install -y -qq jq

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/464753796348/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-terraform@siem-486017.iam.gserviceaccount.com

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Detect changed modules (latest commit in PR)
        id: detect
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          CHANGED=$(git diff --name-only "$BASE" "$HEAD" | grep '\.tf$' | xargs -I {} dirname {} | sort -u || true)

          if [ -z "$CHANGED" ]; then
            echo "modules=" >> $GITHUB_OUTPUT
          else
            echo "modules=$(echo $CHANGED)" >> $GITHUB_OUTPUT
          fi

      - name: Run FinOps per module
        if: steps.detect.outputs.modules != ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/run-module.sh

          for module in ${{ steps.detect.outputs.modules }}; do
            RESULT=$(bash scripts/run-module.sh "$module")
            MODULE_NAME=$(echo "$RESULT" | cut -d '|' -f1)
            TOTAL=$(echo "$RESULT" | cut -d '|' -f2)

            COMMENT_FILE="comment_${MODULE_NAME}.md"

            echo "## ðŸ’° FinOps Audit: ${MODULE_NAME}" > $COMMENT_FILE
            echo "" >> $COMMENT_FILE
            echo "| Field | Value |" >> $COMMENT_FILE
            echo "| :--- | :--- |" >> $COMMENT_FILE
            echo "| Direct Monthly Cost | \$${TOTAL} USD |" >> $COMMENT_FILE
            echo "" >> $COMMENT_FILE
            echo "---" >> $COMMENT_FILE
            echo "## ðŸ¤– Gemini Review" >> $COMMENT_FILE
            echo "" >> $COMMENT_FILE

            cat ${MODULE_NAME}/gemini_output.md >> $COMMENT_FILE

            gh pr comment $PR_NUMBER --body-file $COMMENT_FILE
          done
